<!DOCTYPE html>
<html>
<head>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 0;
    }
    #container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background-color: white;
      border: 1px solid #ddd;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    h1 {
      color: #4285f4;
    }
    h2 {
      color: #333;
    }
    table {
      border-collapse: collapse;
      width: 100%;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }
    .section {
      margin-top: 20px;
      border-top: 2px solid #4285f4;
      padding-top: 20px;
    }
  </style>
</head>
<body>
  <div id="container">
    <h1>System Details Report</h1>
    <p>This report was generated by Ansible on {{ ansible_date_time.date }} at {{ ansible_date_time.time }}.</p>

    <div class="section">
      <h2>System Information</h2>
      <table>
        <tr>
          <th>Host</th>
          <th>OS</th>
          <th>Kernel</th>
          <th>CPU</th>
          <th>Memory</th>
          <th>IP Address</th>
          <th>Uptime</th>
        </tr>
        {% for host in ansible_play_hosts %}
        <tr>
          <td>{{ hostvars[host].ansible_nodename }}</td>
          <td>{{ hostvars[host].ansible_distribution }} {{ hostvars[host].ansible_distribution_version }}</td>
          <td>{{ hostvars[host].ansible_kernel }}</td>
          <td>{{ hostvars[host].ansible_processor_vcpus }}</td>
          <td>{{ (hostvars[host].ansible_memtotal_mb / 1024) | round(2) }} GB</td>
          <td>{{ hostvars[host].ansible_default_ipv4.address }}</td>
          <td>{{ (hostvars[host].ansible_uptime_seconds / 3600) | round(2) }} hours</td>
        </tr>
        {% endfor %}
      </table>
    </div>

    <div class="section">
      <h2>Network Interfaces</h2>
      <table>
        <tr>
          <th>Host</th>
          <th>Network Interfaces</th>
        </tr>
        {% for host in ansible_play_hosts %}
        <tr>
          <td>{{ hostvars[host].ansible_nodename }}</td>
          <td>{% for interface in hostvars[host].ansible_interfaces %}
            {{ interface }}: {{ hostvars[host]['ansible_' + interface]['ipv4']['address'] }}<br/>
            {% endfor %}
          </td>
        </tr>
        {% endfor %}
      </table>
    </div>

    <div class="section">
      <h2>Disk Devices</h2>
      <table>
        <tr>
          <th>Host</th>
          <th>Disk Devices</th>
        </tr>
        {% for host in ansible_play_hosts %}
        <tr>
          <td>{{ hostvars[host].ansible_nodename }}</td>
          <td>{% for device in hostvars[host].ansible_devices %}
            {{ device }}: {{ hostvars[host].ansible_devices[device]['size'] }}<br/>
            {% endfor %}
          </td>
        </tr>
        {% endfor %}
      </table>
    </div>

    <div class="section">
      <h2>SSHD Processes</h2>
      <table>
        <tr>
          <th>Host</th>
          <th>PID</th>
          <th>Listening Port</th>
        </tr>
        {% for host in ansible_play_hosts %}
        {% for pid in hostvars[host]['sshd_pids'] %}
        <tr>
          <td>{{ hostvars[host].ansible_nodename }}</td>
          <td>{{ pid }}</td>
          {% if 'LISTEN' in netstat_sshd_output.stdout %}
          <td>{{ netstat_sshd_output.stdout | regex_replace('^tcp.*LISTEN.*sshd', '\\2') }}</td>
          {% else %}
          <td>N/A</td>
          {% endif %}
        </tr>
        {% endfor %}
        {% endfor %}
      </table>
    </div>

    <div class="section">
  <h2>Top Processes</h2>
  <table>
    <tr>
      <th>Host</th>
      <th>Process Name</th>
      <th>CPU Usage (%)</th>
      <th>Memory Usage (%)</th>
    </tr>
    {% for host in ansible_play_hosts %}
    {% for process in hostvars[host]['top_cpu_processes'] %}
    <tr>
      <td>{{ hostvars[host].ansible_nodename }}</td>
      <td>{{ process.split()[0] }}</td>
      <td>{{ process.split()[1] }}</td>
      <td>{{ process.split()[2] }}</td>
    </tr>
    {% endfor %}
    {% endfor %}
  </table>
</div>

    <div class="section">
      <h2>Operating System Distribution</h2>
      <table>
        <tr>
          <th>Host</th>
          <th>OS Distribution</th>
        </tr>
        {% for host in ansible_play_hosts %}
        <tr>
          <td>{{ hostvars[host].ansible_nodename }}</td>
          <td>{{ hostvars[host].ansible_distribution }}</td>
        </tr>
        {% endfor %}
      </table>
    </div>
  </div>
</body>
</html>
